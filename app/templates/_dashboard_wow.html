{# templates/dashboard_wow.html #}
{% extends "coreui_base_wow.html" %}
<!-- DEMO: run flask, then go to: http://127.0.0.1:5000/ui/wow/dashboard -->

{% block title %}AMS – Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('main.menu') }}">Home</a></li>
<li class="breadcrumb-item active"><span>Dashboard</span></li>
{% endblock %}

{# Optional: override KPI numbers from context, else fallback stays #}
{% block kpis %}
<div class="row g-3">
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card kpi-card"><div class="card-body">
      <i class="kpi-icon cil-people"></i>
      <div>
        <div class="fs-5 fw-semibold" id="kpiTotalStudents">{{ total_students or "—" }}</div>
        <div class="text-body-secondary small">Total Students</div>
      </div>
    </div></div>
  </div>
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card kpi-card"><div class="card-body">
      <i class="kpi-icon cil-check-circle"></i>
      <div>
        <div class="fs-5 fw-semibold" id="kpiEligible">{{ eligible_count or "—" }}</div>
        <div class="text-body-secondary small">Eligible</div>
      </div>
    </div></div>
  </div>
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card kpi-card"><div class="card-body">
      <i class="kpi-icon cil-hourglass"></i>
      <div>
        <div class="fs-5 fw-semibold" id="kpiPending">{{ pending_count or "—" }}</div>
        <div class="text-body-secondary small">Pending Review</div>
      </div>
    </div></div>
  </div>
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card kpi-card"><div class="card-body">
      <i class="kpi-icon cil-graph"></i>
      <div>
        <div class="fs-5 fw-semibold" id="kpiAvgGPA">{{ avg_pred_gpa or "—" }}</div>
        <div class="text-body-secondary small">Avg Predicted GPA</div>
      </div>
    </div></div>
  </div>
</div>
{% endblock %}

{% block page_toolbar %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex gap-2">
    <a href="{{ url_for('main.point_inputs') }}" class="btn btn-primary">
      <i class="icon me-1 cil-plus"></i> Add Student
    </a>
    <button class="btn btn-outline-secondary" onclick="AMS.showToast('Filters reset')">
      <i class="icon me-1 cil-filter-x"></i> Reset Filters
    </button>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-primary" id="btnExportCSV">
      <i class="icon me-1 cil-cloud-download"></i> Export CSV
    </button>
  </div>
</div>
{% endblock %}

{# Replace demo charts with real data if provided #}
{% block charts %}
<div class="row g-3 mt-1">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header">Eligibility Breakdown</div>
      <div class="card-body"><canvas id="chartEligibility"></canvas></div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-header">Predicted GPA Distribution</div>
      <div class="card-body"><canvas id="chartGPA"></canvas></div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="card mt-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">Students</div>
    <div class="input-group" style="max-width: 320px;">
      <span class="input-group-text"><i class="icon cil-search"></i></span>
      <input type="text" id="quickSearch" class="form-control" placeholder="Search table…">
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table id="studentsTable" class="table table-striped table-hover w-100 align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Applying Grade</th>
            <th>Status</th>
            <th>Pred. GPA</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.grade }}</td>
            <td>
              {% if s.status == 'Eligible' %}
                <span class="badge text-bg-success">Eligible</span>
              {% elif s.status == 'Pending' %}
                <span class="badge text-bg-warning">Pending</span>
              {% else %}
                <span class="badge text-bg-danger">Ineligible</span>
              {% endif %}
            </td>
            <td>{{ "%.2f"|format(s.pred_gpa) if s.pred_gpa is not none else "—" }}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a class="btn btn-outline-primary" href="{{ url_for('main.student_details') }}?id_query={{ s.id }}">
                <i class="icon cil-magnifying-glass"></i>
              </a>
              <a class="btn btn-outline-secondary" href="{{ url_for('main.enter_report_card') }}?id_query={{ s.id }}">
              <i class="icon cil-pencil"></i>
              </a>
                <button class="btn btn-outline-danger" onclick="AMS.showToast('Deleted {{ s.id }}', false)">
                  <i class="icon cil-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- Chart.js (needed for the two demo charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ----- DataTables v2 init (no jQuery) -----
    const tableEl = document.getElementById('studentsTable');
    if (tableEl && typeof DataTable !== 'undefined') {
      const dt = new DataTable(tableEl, {
        responsive: true,
        layout: { topStart: 'buttons' },
        buttons: ['csv']  // keep it light; no excel/pdf
      });

      // Quick search
      const qs = document.getElementById('quickSearch');
      if (qs) qs.addEventListener('input', (e) => {
        dt.search(e.target.value).draw();
      });

      // Toolbar export button triggers the DT CSV button
      const btnExport = document.getElementById('btnExportCSV');
      if (btnExport) btnExport.addEventListener('click', () => {
        const csvBtn = document.querySelector('.dt-buttons .buttons-csv');
        if (csvBtn) csvBtn.click();
      });
    }

    // ----- Charts (needs Chart.js) -----
    const elig = {{ eligibility_breakdown|tojson if eligibility_breakdown is defined else '{"Eligible":55,"Pending":30,"Ineligible":15}' }};
    const gpaBins = {{ gpa_histogram|tojson if gpa_histogram is defined else '{"1.0":5,"2.0":18,"3.0":34,"4.0":21}' }};

    const el1 = document.getElementById('chartEligibility');
    if (el1 && window.Chart) {
      new Chart(el1, {
        type: 'doughnut',
        data: { labels: Object.keys(elig), datasets: [{ data: Object.values(elig) }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    const el2 = document.getElementById('chartGPA');
    if (el2 && window.Chart) {
      new Chart(el2, {
        type: 'bar',
        data: { labels: Object.keys(gpaBins), datasets: [{ label: 'Count', data: Object.values(gpaBins) }] },
        options: { plugins: { legend: { display: false } } }
      });
    }
  });
</script>
{% endblock %}
