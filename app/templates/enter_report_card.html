{% extends "coreui_base_wow.html" %}

{% block title %}Enter Report Card Info{% endblock %}

{% block content %}
  {% include '_breadcrumbs.html' %}

  <h1 class="h4 mb-3">Enter Report Card Info</h1>

  <!-- Student summary -->
  <div class="card mb-4">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Student ID</dt>
        <dd class="col-sm-9">{{ results.id }}</dd>

        <dt class="col-sm-3">Applying for Grade</dt>
        <dd class="col-sm-9">{{ results.grade }}</dd>

        <dt class="col-sm-3">Current School</dt>
        <dd class="col-sm-9">{{ results.current_school }}</dd>
      </dl>
    </div>
  </div>

  <!-- Form -->
  <div class="card">
    <div class="card-header">Grades Input</div>
    <div class="card-body">
      <form id="report-card-form" method="POST" action="{{ url_for('main.enter_report_card') }}" class="row g-3">
        <div class="col-sm-6 col-md-4">
          <label for="schedule_option" class="form-label">Select Schedule Option</label>
          <select id="schedule_option" name="schedule_option" class="form-select" required>
            <option value="">--Select Option--</option>
            <option value="9_S">9th grade semester/trimester</option>
            <option value="9_Q">9th grade quarters</option>
            <option value="10_S">10th grade semester/trimester</option>
            <option value="10_Q">10th grade quarters</option>
            <option value="11_S">11th grade semester/trimester</option>
            <option value="11_Q">11th grade quarters</option>
          </select>
        </div>

        <!-- Dynamic grade inputs -->
        <div class="col-12">
          <div id="grade-inputs" class="table-responsive"></div>
        </div>

        <div class="col-12 d-flex justify-content-between">
          <a href="{{ url_for('main.student_details') }}" class="btn btn-outline-secondary">Return to Student Scores</a>
          <button type="submit" class="btn btn-primary">Calculate GPA</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Calculated results -->
  {% if gpa %}
  <div class="alert alert-success mt-3">
    <div><strong>Calculated GPA:</strong> {{ gpa }}</div>
    <div><strong>Calculated Matrix GPA:</strong> {{ matrix_gpa }}</div>
  </div>
  {% endif %}

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert {{ 'alert-success' if category == 'success' else 'alert-danger' }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('report-card-form');
    const select = document.getElementById('schedule_option');
    const container = document.getElementById('grade-inputs');

    if (select) select.addEventListener('change', updateGradeInputs);
    if (form) form.addEventListener('submit', validateGrades);

    function validateGrades(event) {
      const inputs = container.querySelectorAll("input[type='text']");
      let valid = true;
      const gradePattern = /^[A-Da-d][+-]?$|^F$/;

      inputs.forEach(input => {
        input.setCustomValidity("");
        if (!input.value) {
          input.setCustomValidity("This field is required.");
          valid = false;
        } else if (!gradePattern.test(input.value)) {
          input.setCustomValidity("Enter A, B, C, D (optional +/−) or F");
          valid = false;
        }
      });

      if (!valid) {
        event.preventDefault();
        const firstInvalid = Array.from(inputs).find(i => !i.checkValidity());
        if (firstInvalid) firstInvalid.reportValidity();
      }
    }

    function updateGradeInputs() {
      const option = select.value;
      container.innerHTML = "";
      if (!option) return;

      let subjects = ["english", "math", "science", "social_studies"];
      let gradesPerSubject = 1;
      let headerLabels = [];

      switch (option) {
        case "9_S":  gradesPerSubject = 1; headerLabels = ["8th 1st semester"]; break;
        case "10_S": gradesPerSubject = 1; headerLabels = ["9th 1st semester"]; break;
        case "11_S": gradesPerSubject = 3; headerLabels = ["9th 1st semester","9th 2nd semester","10th 1st semester"]; break;
        case "9_Q":  gradesPerSubject = 2; headerLabels = ["8th 1st quarter","8th 2nd quarter"]; break;
        case "10_Q": gradesPerSubject = 2; subjects.push("language"); headerLabels = ["9th 1st quarter","9th 2nd quarter"]; break;
        case "11_Q": gradesPerSubject = 6; subjects.push("language"); headerLabels = ["9th 1st quarter","9th 2nd quarter","9th 3rd quarter","9th 4th quarter","10th 1st quarter","10th 2nd quarter"]; break;
        default: alert("Please select a valid schedule option."); return;
      }

      const table = document.createElement("table");
      table.className = "table table-bordered table-sm align-middle w-auto grade-table";

      const thead = document.createElement("thead");
      const headRow1 = document.createElement("tr");
      const emptyTh = document.createElement("th");
      headRow1.appendChild(emptyTh);
      headerLabels.forEach(label => {
        const th = document.createElement("th");
        th.textContent = label;
        th.className = "text-center";
        headRow1.appendChild(th);
      });
      thead.appendChild(headRow1);

      const tbody = document.createElement("tbody");

      subjects.forEach(subject => {
        const row = document.createElement("tr");
        const subjectCell = document.createElement("th");
        subjectCell.scope = "row";
        subjectCell.textContent = subject.replace("_", " ").toUpperCase();
        row.appendChild(subjectCell);

        for (let i = 1; i <= gradesPerSubject; i++) {
          const cell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "text";
          input.name = subject + (gradesPerSubject > 1 ? `_q${i}` : "");
          input.required = true;
          input.pattern = "^[A-Da-d][+-]?$|^F$";
          input.title = "Enter A, B, C, D (optional +/−) or F";
          input.className = "form-control";

          input.addEventListener("input", function () {
            if (!input.value) {
              input.setCustomValidity("This field is required.");
            } else if (!/^[A-Da-d][+-]?$|^F$/.test(input.value)) {
              input.setCustomValidity("Enter A, B, C, D (optional +/−) or F");
            } else {
              input.setCustomValidity("");
            }
          });

          cell.appendChild(input);
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      container.appendChild(table);
    }
  });
</script>
{% endblock %}